# Creating an MCP Server

MCP servers are the backbone of the tool system. They are independent processes that expose functions (tools) that the LLM can call.

## 1. Server Structure

A new MCP server is a simple Python script using the `FastMCP` library.

1.  Create a new directory for your server inside `backend/mcp/`.
2.  Inside that directory, create a `main.py` file.

**Example `main.py`:**
```python
from fastmcp import FastMCP
from typing import Dict, Any

mcp = FastMCP(name="MyExampleServer")

@mcp.tool
def my_tool(parameter: str) -> Dict[str, Any]:
    """
    A simple tool that takes a string and returns a dictionary.
    The docstring is used as the tool's description for the LLM.
    """
    # The dictionary you return is the 'results' object.
    return {
        "input_received": parameter,
        "status": "success"
    }

if __name__ == "__main__":
    mcp.run()
```

## 2. The MCP v2 Tool Contract

When a tool is executed, its return value must adhere to a specific JSON structure, known as the "v2 contract." This allows the UI to correctly process and display the results.

The returned JSON object has the following structure:

*   **`results`** (required): A JSON object containing the primary, human-readable result of the tool. This should be concise.
*   **`artifacts`** (optional): A list of files generated by the tool. This is the preferred way to return files or large data blobs. Each artifact is an object with:
    *   `name`: The filename (e.g., `report.html`).
    *   `b64`: The base64-encoded content of the file.
    *   `mime`: The MIME type (e.g., `text/html`, `image/png`).
*   **`display`** (optional): A JSON object that provides hints to the UI on how to display the artifacts, such as whether to open the canvas automatically.

**Example tool returning an artifact:**
```python
import base64

@mcp.tool
def create_html_report(title: str) -> Dict[str, Any]:
    """Generates and returns an HTML report as an artifact."""
    html_content = f"<html><body><h1>{title}</h1></body></html>"
    b64_content = base64.b64encode(html_content.encode()).decode()

    return {
        "results": {"summary": f"Successfully generated report: {title}"},
        "artifacts": [{
            "name": "report.html",
            "b64": b64_content,
            "mime": "text/html"
        }],
        "display": {
            "open_canvas": True,
            "primary_file": "report.html"
        }
    }
```

For more details on how the canvas chooses viewers (including iframe support for external dashboards and embedded HTML), see `docs/developer/canvas-renderers.md`.

## 3. Registering the Server

After creating your server, you must register it in `config/overrides/mcp.json`.

```json
{
  "MyExampleServer": {
    "command": ["python", "mcp/MyExampleServer/main.py"],
    "cwd": "backend",
    "groups": ["users"],
    "description": "An example server with a simple tool."
  }
}
```

*   **`command`**: The command to start the server.
*   **`cwd`**: The working directory from which to run the command.
*   **`groups`**: A list of user groups that can access this server's tools.
*   **`description`**: A description of the server shown in the UI.
*   **`auth_token`**: (optional) For HTTP/SSE servers, the bearer token for authentication. Use environment variable substitution like `"${MCP_TOKEN}"` for security.

## 4. Argument Injection

To enhance security and simplify tool development, the backend can automatically inject certain arguments into your tool calls.

*   **`username` Injection (Security Feature)**: If your tool's function signature includes a `username: str` parameter, the backend will **always overwrite** any value for it with the authenticated user's identity. This is a critical security feature to ensure a tool always runs with the correct user context.

*   **File URL Injection**: If your tool accepts a `filename: str` or `file_names: List[str]` parameter, the backend will automatically convert any session files passed by the LLM into secure, temporary URLs. Your tool can then fetch the file content from these URLs. See the [Working with Files](working-with-files.md) guide for more details.
