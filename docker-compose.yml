services:
  minio:
    image: minio/minio:latest
    container_name: atlas-minio
    ports:
      - "9000:9000"  # S3 API
      - "9001:9001"  # Web Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - ./data/minio:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - atlas-network

  minio-init:
    image: minio/mc:latest
    container_name: atlas-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/atlas-files --ignore-existing;
      mc anonymous set download myminio/atlas-files;
      echo 'MinIO initialization complete';
      "
    networks:
      - atlas-network

  postgres:
    image: postgres:16-alpine
    container_name: atlas-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: atlas
      POSTGRES_PASSWORD: atlas
      POSTGRES_DB: atlas_chat_history
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U atlas -d atlas_chat_history"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - atlas-network

  atlas-ui:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_APP_NAME: "Chat UI"
    container_name: atlas-ui-3
    ports:
      - "8000:8000"
    environment:
      # Core / Development
      - DEBUG_MODE=true
      - PORT=8000
      - APP_NAME=ATLAS
      - ATLAS_HOST=0.0.0.0  # Required for Docker container to accept external connections
      - ENVIRONMENT=development
      
      # API Keys for LLM services
      - OPENAI_API_KEY=sk-pro
      - ANTHROPIC_API_KEY=your_anthropic_api_key_here
      - GOOGLE_API_KEY=your_google_api_key_here
      - OPENROUTER_API_KEY=sk-or
      - CEREBRAS_API_KEY=your_cerebras_api_key_here
      - GROQ_API_KEY=your-groq_api_key_here
      
      # Banner system configuration
      - BANNER_ENABLED=true
      
      # Log level configuration
      - LOG_LEVEL=INFO
      # Suppress LiteLLM verbose logging
      - FEATURE_SUPPRESS_LITELLM_LOGGING=true

      - USE_NEW_FRONTEND=true
      
      # Feature Flags
      - FEATURE_WORKSPACES_ENABLED=false
      - FEATURE_RAG_ENABLED=false
      - FEATURE_TOOLS_ENABLED=true
      - FEATURE_MARKETPLACE_ENABLED=true
      - FEATURE_FILES_PANEL_ENABLED=true
      - FEATURE_CHAT_HISTORY_ENABLED=true
      # Chat history DB (choose one):
      # DuckDB (default, no extra services required):
      - CHAT_HISTORY_DB_URL=duckdb:///data/chat_history.db
      # PostgreSQL (production / multi-user):
      # - CHAT_HISTORY_DB_URL=postgresql://atlas:atlas@postgres:5432/atlas_chat_history
      - FEATURE_COMPLIANCE_LEVELS_ENABLED=false
      - FEATURE_METRICS_LOGGING_ENABLED=false
      - FEATURE_SPLASH_SCREEN_ENABLED=false
      - FEATURE_DOMAIN_WHITELIST_ENABLED=false
      - FEATURE_MCP_AUTO_RECONNECT_ENABLED=false
      - MCP_DISCOVERY_TIMEOUT=30
      - MCP_CALL_TIMEOUT=120
      - FEATURE_FILE_CONTENT_EXTRACTION_ENABLED=false

      # Agent mode configuration
      - AGENT_MAX_STEPS=30
      - AGENT_DEFAULT_ENABLED=true
      - FEATURE_AGENT_MODE_AVAILABLE=true
      - AGENT_LOOP_STRATEGY=think-act
      
      # Tool approval configuration
      - REQUIRE_TOOL_APPROVAL_BY_DEFAULT=false
      - FORCE_TOOL_APPROVAL_GLOBALLY=false
      
      - APP_LOG_DIR=/app/logs
      
      - CAPABILITY_TOKEN_SECRET=blablah
      
      # S3/MinIO Storage Configuration
      - S3_ENDPOINT=http://minio:9000
      - S3_BUCKET_NAME=atlas-files
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_REGION=us-east-1
      - S3_USE_SSL=false
      
      # Content Security Policy (CSP) configuration
      - "SECURITY_CSP_VALUE=default-src 'self'; img-src 'self' data: blob:; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self'; frame-src 'self' blob: data: https://www.sandia.gov; frame-ancestors 'self'"
    volumes:
      - ./logs:/app/logs:U
      - ./config:/app/config:U
    depends_on:
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    networks:
      - atlas-network

networks:
  atlas-network:
    driver: bridge

volumes:
  minio-data:
  postgres-data:
