apiVersion: batch/v1
kind: Job
metadata:
  name: minio-init
  namespace: atlas
spec:
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: minio-init
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-minio
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for minio to be ready..."
              until wget -qO- http://minio:9000/minio/health/ready 2>/dev/null; do
                echo "  minio not ready yet, retrying in 3s..."
                sleep 3
              done
              echo "minio is ready."
      containers:
        - name: minio-init
          image: minio/mc:latest
          command:
            - sh
            - -c
            - |
              mc alias set myminio http://minio:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD"
              mc mb myminio/${S3_BUCKET_NAME} --ignore-existing
              mc anonymous set download myminio/${S3_BUCKET_NAME}
              echo "MinIO initialization complete"
          env:
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: atlas-secrets
                  key: S3_ACCESS_KEY
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: atlas-secrets
                  key: S3_SECRET_KEY
            - name: S3_BUCKET_NAME
              valueFrom:
                configMapKeyRef:
                  name: atlas-config
                  key: S3_BUCKET_NAME
